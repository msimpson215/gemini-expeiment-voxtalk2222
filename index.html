<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Walmart AI - VoxTalk Realtime</title>
    <style>
        :root { --wmt-blue: #0071ce; --wmt-yellow: #ffc220; }
        body { margin: 0; font-family: "Segoe UI", sans-serif; background: #fff; display: flex; flex-direction: column; align-items: center; height: 100vh; }
        #header { width: 100%; display: flex; flex-direction: column; align-items: center; padding: 40px 0; }
        .wmt-logo { font-size: 48px; font-weight: bold; color: var(--wmt-blue); display: flex; align-items: center; }
        .spark { color: var(--wmt-yellow); margin-left: 5px; font-size: 55px; }
        .button-row { display: flex; gap: 15px; margin-top: 20px; }
        .action-btn { width: 120px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-weight: bold; color: var(--wmt-blue); text-align: center; }
        #voice-container { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* The Realtime Pulsating Circle */
        #pttBtn { 
            width: 150px; height: 150px; border-radius: 50%; border: none; cursor: pointer;
            background: radial-gradient(circle at 30% 30%, var(--wmt-blue), #1e40af);
            box-shadow: 0 6px 18px rgba(0,113,206,.3); transition: 0.2s;
        }
        #pttBtn.listening { animation: listenPulse 1.6s ease-in-out infinite; }
        @keyframes listenPulse { 
            0% { box-shadow: 0 0 0 0 rgba(0,113,206,.7); }
            50% { box-shadow: 0 0 0 20px rgba(0,113,206,0); }
            100% { box-shadow: 0 0 0 0 rgba(0,113,206,0); }
        }
        
        #answer { width: 400px; margin-top: 20px; padding: 15px; border-radius: 12px; background: #f9f9f9; border: 1px solid #eee; font-size: 14px; min-height: 50px; }
        #footer { width: 100%; padding: 20px; display: flex; justify-content: space-between; font-size: 12px; color: #999; }
    </style>
</head>
<body>
    <div id="header">
        <div class="wmt-logo">Walmart <span class="spark">âœ±</span></div>
        <div class="button-row"><div class="action-btn">CHECK OUT</div><div class="action-btn">INFO</div><div class="action-btn">CART</div></div>
    </div>

    <div id="voice-container">
        <button id="pttBtn"></button>
        <div id="answer">VoxTalk Realtime Ready...</div>
        <audio id="remote" autoplay playsinline></audio>
    </div>

    <div id="footer"><div>powered by <strong>VoxTalk</strong></div><div>Contact human team</div></div>

    <script>
        const pttBtn = document.getElementById('pttBtn');
        const answerEl = document.getElementById('answer');
        const rtAudio = document.getElementById('remote');

        async function initRealtime() {
            try {
                // Hits your Render server to get the secret session
                const s = await fetch("/session", { method:"POST" });
                const { client_secret, model, voice } = await s.json();

                const pc = new RTCPeerConnection();
                const mic = await navigator.mediaDevices.getUserMedia({ audio:true });
                const micTrack = mic.getTracks()[0];
                micTrack.enabled = false;
                pc.addTrack(micTrack, mic);

                pc.ontrack = (ev) => { rtAudio.srcObject = ev.streams[0]; };

                const dc = pc.createDataChannel("events");
                dc.onmessage = (e) => {
                    const evt = JSON.parse(e.data);
                    if (evt.type === "response.audio_transcription.completed") {
                        answerEl.innerText = "AI: " + evt.transcript;
                    }
                };

                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                const r = await fetch(`https://api.openai.com/v1/realtime?model=${model}`, {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${client_secret.value}`, "Content-Type": "application/sdp" },
                    body: offer.sdp
                });
                await pc.setRemoteDescription({ type: "answer", sdp: await r.text() });

                let talking = false;
                pttBtn.onclick = () => {
                    talking = !talking;
                    micTrack.enabled = talking;
                    pttBtn.classList.toggle('listening', talking);
                    answerEl.innerText = talking ? "Listening..." : "Paused.";
                };
            } catch(err) { answerEl.innerText = "Init Failed. Check API Key!"; }
        }
        initRealtime();
    </script>
</body>
</html>
