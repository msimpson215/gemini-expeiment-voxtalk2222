<script>
    // 1. Setup the "Voice" (Speech Synthesis)
    const synth = window.speechSynthesis;

    function speakBack(text) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 1.0; 
        synth.speak(utterance);
    }

    // 2. Setup the "Ears" (Speech Recognition)
    const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new Recognition();

    recognition.onresult = (event) => {
        const speechToText = event.results[0][0].transcript;
        document.getElementById('manualInput').value = speechToText; // Put text in box
        document.getElementById('transcript').innerText = "You said: " + speechToText;
        sendToBrain(speechToText); // Send it to your Render server
    };

    // 3. The Central Circle Logic (Voice Talk)
    async function startTalking() {
        if(isPaused) return;
        document.getElementById('transcript').innerText = "Listening...";
        recognition.start(); // Trigger the microphone
    }

    // 4. The Text Box Logic (Text Talk)
    async function sendText() {
        const text = document.getElementById('manualInput').value;
        if(!text) return;
        document.getElementById('transcript').innerText = "Typing...";
        sendToBrain(text);
    }

    // 5. The Brain Bridge
    async function sendToBrain(userInput) {
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: userInput })
            });
            const data = await response.json();
            const aiResponse = data.choices[0].message.content;

            // Update UI and Talk Back!
            document.getElementById('transcript').innerText = "AI: " + aiResponse;
            speakBack(aiResponse); 

        } catch (err) {
            document.getElementById('transcript').innerText = "Connection Error.";
        }
    }
</script>
